<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üé® MERCHBOY Coloring Studio</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: #f5f5f5; overflow: hidden; height: 100vh; touch-action: none; }
        .header { background: rgba(255,255,255,.95); backdrop-filter: blur(20px); border-bottom: 2px solid #e0e0e0; padding: 10px 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,.05); position: relative; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.3em; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 800; letter-spacing: 1px; }
        .canvas-container { position: relative; width: 100%; height: calc(100vh - 50px - 90px); display: flex; align-items: center; justify-content: center; padding: 20px; overflow: hidden; }
        #coloringCanvas { border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,.15); display: block; background: white; cursor: crosshair; max-width: 100%; max-height: 100%; object-fit: contain; }
        .toolbar { position: fixed; bottom: 0; left: 0; right: 0; height: 90px; background: rgba(255,255,255,.95); backdrop-filter: blur(20px); border-top: 2px solid #e0e0e0; display: flex; gap: 15px; padding: 15px; overflow-x: auto; align-items: center; justify-content: center; z-index: 20; }
        .control-btn { width: 50px; height: 50px; border: none; border-radius: 50%; background: rgba(255,255,255,.95); cursor: pointer; font-size: 1.5em; box-shadow: 0 4px 15px rgba(0,0,0,.1); transition: all .3s ease; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .control-btn:hover:not(:disabled) { transform: scale(1.1); box-shadow: 0 6px 20px rgba(0,0,0,.15); }
        .control-btn:disabled { opacity: .3; cursor: not-allowed; }
        .control-btn.active { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; }
        .color-input { width: 50px; height: 50px; border: none; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,.1); }
        .size-slider { width: 120px; height: 50px; padding: 10px 0; }
        .panel-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.4); display: none; z-index: 100; align-items: center; justify-content: center; }
        .panel-overlay.active { display: flex; }
        .panel { background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,.3); max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; animation: slideUp .3s ease; }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 2px solid #e0e0e0; position: sticky; top: 0; background: white; border-radius: 15px 15px 0 0; }
        .panel-title { font-size: 1.3em; font-weight: 700; color: #667eea; }
        .panel-close { width: 40px; height: 40px; border: none; background: rgba(102,126,234,.1); border-radius: 50%; cursor: pointer; font-size: 1.3em; transition: all .3s ease; }
        .panel-close:hover { transform: rotate(90deg); background: rgba(102,126,234,.2); }
        .panel-content { padding: 20px; }
        .color-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 10px; margin: 15px 0; }
        .color-swatch { width: 100%; aspect-ratio: 1; border-radius: 10px; cursor: pointer; border: 3px solid transparent; transition: all .2s ease; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
        .color-swatch:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,.2); }
        .color-swatch.active { border-color: #667eea; }
        .tool-list { list-style: none; display: flex; flex-direction: column; gap: 10px; }
        .tool-item { padding: 12px; border-radius: 8px; background: #f5f5f5; cursor: pointer; transition: all .2s ease; display: flex; align-items: center; gap: 10px; }
        .tool-item:hover { background: #e8e8f5; }
        .tool-item.active { background: #667eea; color: white; }
        .tool-icon { font-size: 1.5em; }
        .tool-label { font-weight: 600; }
        body.fullscreen .header, body.fullscreen .toolbar { display: none; }
        body.fullscreen .canvas-container { height: 100vh; padding: 0; }
        .fullscreen-exit { position: fixed; top: 20px; right: 20px; width: 50px; height: 50px; background: rgba(0,0,0,.7); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1.5em; display: none; z-index: 200; align-items: center; justify-content: center; }
        body.fullscreen .fullscreen-exit { display: flex; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé® MERCHBOY Coloring Studio</h1>
        <button class="control-btn" id="fullscreenBtn" title="Fullscreen">üñ•Ô∏è</button>
    </div>
    
    <div class="canvas-container">
        <canvas id="coloringCanvas"></canvas>
    </div>
    
    <div class="toolbar">
        <button class="control-btn" id="toolsBtn" title="Tools">üõ†Ô∏è</button>
        <button class="control-btn" id="colorsBtn" title="Colors">üé®</button>
        <button class="control-btn" id="undoBtn" title="Undo" disabled>‚Ü∂</button>
        <button class="control-btn" id="redoBtn" title="Redo" disabled>‚Ü∑</button>
        <button class="control-btn" id="clearBtn" title="Clear">üóëÔ∏è</button>
        <button class="control-btn" id="saveBtn" title="Save">üíæ</button>
    </div>
    
    <div class="panel-overlay" id="toolsPanel">
        <div class="panel">
            <div class="panel-header">
                <h2 class="panel-title">Drawing Tools</h2>
                <button class="panel-close" onclick="closePanel('toolsPanel')">‚úï</button>
            </div>
            <div class="panel-content">
                <ul class="tool-list">
                    <li class="tool-item active" data-tool="brush">
                        <span class="tool-icon">üñåÔ∏è</span>
                        <span class="tool-label">Brush</span>
                    </li>
                    <li class="tool-item" data-tool="eraser">
                        <span class="tool-icon">üßπ</span>
                        <span class="tool-label">Eraser</span>
                    </li>
                    <li class="tool-item" data-tool="fill">
                        <span class="tool-icon">ü™£</span>
                        <span class="tool-label">Fill</span>
                    </li>
                </ul>
                <label style="display:block;margin-top:20px">
                    <strong>Brush Size:</strong>
                    <input type="range" class="size-slider" id="sizeSlider" min="1" max="50" value="5">
                    <span id="sizeValue">5</span> px
                </label>
            </div>
        </div>
    </div>
    
    <div class="panel-overlay" id="colorsPanel">
        <div class="panel">
            <div class="panel-header">
                <h2 class="panel-title">Colors</h2>
                <button class="panel-close" onclick="closePanel('colorsPanel')">‚úï</button>
            </div>
            <div class="panel-content">
                <label style="display:block;margin-bottom:15px">
                    <strong>Pick Color:</strong><br>
                    <input type="color" class="color-input" id="colorPicker" value="#000000">
                </label>
                
                <div>
                    <strong>Recent Colors:</strong>
                    <div class="color-grid" id="recentColorsGrid"></div>
                </div>
                
                <div style="margin-top:20px">
                    <strong>Canvas Background:</strong>
                    <div class="color-grid" id="bgColorOptions"></div>
                </div>
            </div>
        </div>
    </div>
    
    <button class="fullscreen-exit" id="fullscreenExit">‚úï Exit</button>

    <script>
        const CONFIG = {
            MAX_RECENT_COLORS: 10,
            MAX_HISTORY_SIZE: 50,
            DEFAULT_BRUSH_SIZE: 5,
            CANVAS_WIDTH: 800,
            CANVAS_HEIGHT: 600
        };

        let state = {
            currentTool: 'brush',
            currentColor: '#000000',
            toolSize: CONFIG.DEFAULT_BRUSH_SIZE,
            canvasBgColor: '#ffffff',
            recentColors: [],
            isDrawing: false,
            history: [],
            historyStep: -1
        };

        const canvas = document.getElementById('coloringCanvas');
        const ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('colorPicker');
        const sizeSlider = document.getElementById('sizeSlider');
        const sizeValue = document.getElementById('sizeValue');

        function initCanvas() {
            canvas.width = CONFIG.CANVAS_WIDTH;
            canvas.height = CONFIG.CANVAS_HEIGHT;
            ctx.fillStyle = state.canvasBgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveHistory();
        }

        document.querySelectorAll('.tool-item').forEach(item => {
            item.addEventListener('click', (e) => {
                document.querySelectorAll('.tool-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                state.currentTool = item.dataset.tool;
                updateCursor();
            });
        });

        colorPicker.addEventListener('change', (e) => {
            state.currentColor = e.target.value;
            updateRecentColors();
        });

        function updateRecentColors() {
            if (!state.recentColors.includes(state.currentColor)) {
                state.recentColors.unshift(state.currentColor);
                if (state.recentColors.length > CONFIG.MAX_RECENT_COLORS) {
                    state.recentColors.pop();
                }
            }
            renderRecentColors();
        }

        function renderRecentColors() {
            const grid = document.getElementById('recentColorsGrid');
            grid.innerHTML = state.recentColors.map(color => 
                `<div class="color-swatch" style="background:${color}" onclick="setColor('${color}')"></div>`
            ).join('');
        }

        function setColor(color) {
            state.currentColor = color;
            colorPicker.value = color;
            updateRecentColors();
        }

        sizeSlider.addEventListener('input', (e) => {
            state.toolSize = parseInt(e.target.value);
            sizeValue.textContent = state.toolSize;
        });

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        function startDrawing(e) {
            state.isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            if (state.currentTool === 'brush' || state.currentTool === 'eraser') {
                ctx.beginPath();
                ctx.moveTo(x, y);
            } else if (state.currentTool === 'fill') {
                floodFill(x, y);
                saveHistory();
            }
        }

        function draw(e) {
            if (!state.isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            if (state.currentTool === 'brush') {
                ctx.strokeStyle = state.currentColor;
                ctx.lineWidth = state.toolSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.lineTo(x, y);
                ctx.stroke();
            } else if (state.currentTool === 'eraser') {
                ctx.clearRect(x - state.toolSize/2, y - state.toolSize/2, state.toolSize, state.toolSize);
            }
        }

        function stopDrawing() {
            if (state.isDrawing) {
                state.isDrawing = false;
                saveHistory();
            }
        }

        function floodFill(startX, startY) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const stack = [[Math.floor(startX), Math.floor(startY)]];
            const visited = new Set();
            
            const fillColor = hexToRgb(state.currentColor);
            const fillR = fillColor.r, fillG = fillColor.g, fillB = fillColor.b;
            
            while (stack.length > 0) {
                const [x, y] = stack.pop();
                const key = `${x},${y}`;
                
                if (visited.has(key) || x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
                
                const index = (y * canvas.width + x) * 4;
                visited.add(key);
                
                data[index] = fillR;
                data[index + 1] = fillG;
                data[index + 2] = fillB;
                data[index + 3] = 255;
                
                stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 0, b: 0 };
        }

        function saveHistory() {
            if (state.historyStep < state.history.length - 1) {
                state.history = state.history.slice(0, state.historyStep + 1);
            }
            state.history.push(canvas.toDataURL());
            if (state.history.length > CONFIG.MAX_HISTORY_SIZE) {
                state.history.shift();
            }
            state.historyStep = state.history.length - 1;
            updateHistoryButtons();
        }

        function undo() {
            if (state.historyStep > 0) {
                state.historyStep--;
                restoreHistory(state.historyStep);
            }
        }

        function redo() {
            if (state.historyStep < state.history.length - 1) {
                state.historyStep++;
                restoreHistory(state.historyStep);
            }
        }

        function restoreHistory(step) {
            const img = new Image();
            img.src = state.history[step];
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                updateHistoryButtons();
            };
        }

        function updateHistoryButtons() {
            document.getElementById('undoBtn').disabled = state.historyStep <= 0;
            document.getElementById('redoBtn').disabled = state.historyStep >= state.history.length - 1;
        }

        function openPanel(panelId) {
            document.getElementById(panelId).classList.add('active');
        }

        function closePanel(panelId) {
            document.getElementById(panelId).classList.remove('active');
        }

        document.getElementById('toolsBtn').addEventListener('click', () => openPanel('toolsPanel'));
        document.getElementById('colorsBtn').addEventListener('click', () => openPanel('colorsPanel'));
        document.getElementById('undoBtn').addEventListener('click', undo);
        document.getElementById('redoBtn').addEventListener('click', redo);

        document.getElementById('clearBtn').addEventListener('click', () => {
            if (confirm('Clear this page? üé®')) {
                ctx.fillStyle = state.canvasBgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                saveHistory();
            }
        });

        document.getElementById('saveBtn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `merchboy-coloring-${new Date().toISOString().split('T')[0]}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });

        document.getElementById('fullscreenBtn').addEventListener('click', () => {
            document.body.classList.add('fullscreen');
        });

        document.getElementById('fullscreenExit').addEventListener('click', () => {
            document.body.classList.remove('fullscreen');
        });

        document.querySelectorAll('.panel-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        function updateCursor() {
            canvas.style.cursor = state.currentTool === 'eraser' ? 'not-allowed' : 'crosshair';
        }

        initCanvas();
        updateRecentColors();
        renderRecentColors();
        
        const bgColors = ['#ffffff', '#fffef2', '#f0f4f8', '#fff0f5'];
        const bgGrid = document.getElementById('bgColorOptions');
        bgGrid.innerHTML = bgColors.map(color => 
            `<div class="color-swatch" style="background:${color}" onclick="setBgColor('${color}')"></div>`
        ).join('');

        function setBgColor(color) {
            state.canvasBgColor = color;
            ctx.fillStyle = color;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
    </script>
</body>
</html>
